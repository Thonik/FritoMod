#!/bin/bash
PATH=/bin:/usr/bin:$HOME/bin:$FM_ROOT

source fm-library.sh
make_root

case $1 in
	-f)
		FORCE=true
		shift
	;;
esac;

name=$1
if [ -f $1 ]; then
	name=$1
elif [ -f $1.lua ]; then
	name=$1.lua
elif [ -f $1.xml ]; then
	name=$1.xml
elif [ "$FORCE" ]; then
	if ! `echo $1 | grep -q '\.lua'`; then
		name=$1.lua
	fi
else
	error "file not found or is not a file: $1"
fi;

l=`readlink -f $root | wc -m`
let l++
path=`readlink -f $name | trim $l`

echo $path | grep -q '/' || error "opening a root file does not make sense"

this=${path%%/*}
shared_path=${path#*/}

function write_test_suite {
	cat >$1 <<EOF
local Suite=CreateTestSuite("${path%.*}");

function Suite:TestFoo()
	-- TODO: Write this test.
end;
EOF
}

if echo $this | grep -q '_Tests$'; then
	other_path="$root/${this%_*}"
	[ -e $name ] || write_test_suite $name
else
	other_path="$root/$this""_Tests"
	tests="$other_path/$shared_path"
	[ -e $tests ] || write_test_suite $tests
fi
if `echo $shared_path | grep -q '/'`; then
	mkdir -p $other_path/${shared_path%/*}
else
	mkdir -p $other_path
fi
$EDITOR $name $other_path/$shared_path
