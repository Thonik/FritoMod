#!/bin/bash
PATH=/bin:/usr/bin

get_file_list() {
    find $* -maxdepth 1 -name "*.lua" ! -executable -print0 | xargs -0 ./get-requires | grep -v -e'^[#!]';
}

format_files() {
    echo '<Ui xmlns="http://www.blizzard.com/wow/ui/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.blizzard.com/wow/ui/ ..\FrameXML\UI.xsd">'
    while read f; do
        f=`basename $f | sed -e 's#/#\\\\#g'`
        echo '<Script file="'$f'"/>'
    done;
    echo "</Ui>"
}

update_simple_files() {
    get_file_list $1 | grep -e "^$1" | format_files >"$1/files.xml"
}

case $* in 
    wow_tests) update_simple_files wow/tests ;;
    wow) get_file_list wow | format_files >wow/files.xml ;;
    labs) update_simple_files labs ;;
    tests) update_simple_files tests ;;
    *) get_file_list . | format_files >files.xml ;;
esac
